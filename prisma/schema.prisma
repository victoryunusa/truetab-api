generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                     String             @id @default(uuid())
  email                  String             @unique
  password               String
  firstName              String
  lastName               String?
  role                   Role
  brandId                String?
  createdAt              DateTime           @default(now())
  updatedAt              DateTime           @updatedAt
  refreshTokenVersion    Int                @default(0)
  active                 Boolean            @default(true)
  phone                  String?
  currentBranchId        String?
  auditLogs              AuditLog[]
  ownedBrands            Brand[]            @relation("BrandOwner")
  CashMovements          CashMovement[]
  CashSessionsClosed     CashSession[]      @relation("SessionClosedBy")
  CashSessionsOpened     CashSession[]      @relation("SessionOpenedBy")
  OrderLog               OrderLog[]
  createdOrders          Order[]            @relation("OrderCreatedBy")
  waiterOrders           Order[]            @relation("OrderWaiter")
  PurchaseOrder          PurchaseOrder[]
  RegisterSessionsClosed RegisterSession[]  @relation("RegisterClosedBy")
  RegisterSessionsOpened RegisterSession[]  @relation("RegisterOpenedBy")
  StockAdjustment        StockAdjustment[]
  StockTransaction       StockTransaction[]
  StockTransfer          StockTransfer[]
  TipAllocation          TipAllocation[]
  tips                   Tip[]
  userBranches           UserBranch[]
  brand                  Brand?             @relation("BrandUsers", fields: [brandId], references: [id])
  branch                 Branch?            @relation(fields: [currentBranchId], references: [id])
  branches               Branch[]           @relation("BranchUsers")

  @@index([brandId])
  @@map("users")
}

model Brand {
  id                  String                @id @default(uuid())
  name                String
  ownerId             String
  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @updatedAt
  countryId           String?
  currency            String
  email               String                @unique
  url                 String?               @unique
  stripeCustomerId    String?               @unique
  polarCustomerId     String?               @unique
  branches            Branch[]
  country             Country?              @relation(fields: [countryId], references: [id])
  owner               User                  @relation("BrandOwner", fields: [ownerId], references: [id])
  CashMovement        CashMovement[]
  CashSession         CashSession[]
  Category            Category[]
  Customer            Customer[]
  KitchenStation      KitchenStation[]
  KitchenTicket       KitchenTicket[]
  MenuCategory        MenuCategory[]
  MenuItem            MenuItem[]
  ModifierGroup       ModifierGroup[]
  Order               Order[]
  Payment             Payment[]
  PrintJob            PrintJob[]
  Printer             Printer[]
  Product             Product[]
  Promotion           Promotion[]
  PurchaseOrder       PurchaseOrder[]
  Recipe              Recipe[]
  RegisterSession     RegisterSession[]
  Register            Register[]
  Reservation         Reservation[]
  ServiceChargeConfig ServiceChargeConfig[]
  StockAdjustment     StockAdjustment[]
  StockTransaction    StockTransaction[]
  StockTransfer       StockTransfer[]
  subscription        Subscription?
  Supplier            Supplier[]
  Table               Table[]
  TaxRate             TaxRate[]
  TipSettlement       TipSettlement[]
  Tip                 Tip[]
  users               User[]                @relation("BrandUsers")
  WaitlistEntry       WaitlistEntry[]
  Zone                Zone[]
  AIUsageLog          AIUsageLog[]

  @@unique([ownerId, name])
  @@map("brands")
}

model Branch {
  id                  String                @id @default(uuid())
  name                String
  location            String?
  brandId             String
  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @updatedAt
  countryId           String?
  currency            String
  defaultBillType     BillType              @default(FINE_DINE)
  BranchItemVariant   BranchItemVariant[]
  brand               Brand                 @relation(fields: [brandId], references: [id])
  country             Country?              @relation(fields: [countryId], references: [id])
  CashMovement        CashMovement[]
  CashSession         CashSession[]
  KitchenStation      KitchenStation[]
  KitchenTicket       KitchenTicket[]
  Order               Order[]
  Payment             Payment[]
  PrintJob            PrintJob[]
  Printer             Printer[]
  RegisterSession     RegisterSession[]
  Register            Register[]
  Reservation         Reservation[]
  ServiceChargeConfig ServiceChargeConfig[]
  transfersFrom       StockTransfer[]       @relation("TransferFromBranch")
  transfersTo         StockTransfer[]       @relation("TransferToBranch")
  Table               Table[]
  TaxRate             TaxRate[]
  TipSettlement       TipSettlement[]
  Tip                 Tip[]
  userBranches        UserBranch[]
  User                User[]
  WaitlistEntry       WaitlistEntry[]
  Zone                Zone[]
  users               User[]                @relation("BranchUsers")

  @@unique([brandId, name])
  @@index([brandId])
  @@map("branches")
}

model UserBranch {
  id        String   @id @default(uuid())
  userId    String
  branchId  String
  isActive  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  branch    Branch   @relation(fields: [branchId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, branchId])
  @@map("user_branches")
}

model SubscriptionPlan {
  id                    String         @id @default(uuid())
  name                  String
  description           String?
  priceMonthly          Float
  priceYearly           Float
  currency              String
  maxBranches           Int?
  maxStaff              Int?
  features              Json
  trialDays             Int            @default(14)
  createdAt             DateTime       @default(now())
  updatedAt             DateTime       @updatedAt
  isDefault             Boolean        @default(false)
  stripePriceIdMonthly  String?        @unique
  stripePriceIdYearly   String?        @unique
  stripeProductId       String?        @unique
  polarProductIdMonthly String?        @unique
  polarProductIdYearly  String?        @unique
  subscriptions         Subscription[]

  @@unique([name, currency])
  @@map("subscription_plans")
}

model Subscription {
  id                   String                @id @default(uuid())
  brandId              String                @unique
  planId               String
  status               SubscriptionStatus
  trialEndsAt          DateTime?
  currentPeriodEnd     DateTime
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  cancelAtPeriodEnd    Boolean               @default(false)
  canceledAt           DateTime?
  stripePriceId        String?
  stripeSubscriptionId String?               @unique
  polarProductId       String?
  polarSubscriptionId  String?               @unique
  provider             PaymentProvider       @default(STRIPE)
  invoices             SubscriptionInvoice[]
  brand                Brand                 @relation(fields: [brandId], references: [id])
  plan                 SubscriptionPlan      @relation(fields: [planId], references: [id])

  @@index([planId])
  @@index([stripeSubscriptionId])
  @@index([polarSubscriptionId])
  @@map("subscriptions")
}

model SubscriptionInvoice {
  id                    String          @id @default(uuid())
  invoiceNumber         String          @unique
  subscriptionId        String
  brandId               String
  amount                Float
  currency              String
  status                InvoiceStatus   @default(PENDING)
  period                String
  billingPeriod         String
  periodStart           DateTime
  periodEnd             DateTime
  dueDate               DateTime?
  paidAt                DateTime?
  provider              PaymentProvider
  stripeInvoiceId       String?         @unique
  stripePaymentIntentId String?
  polarInvoiceId        String?         @unique
  polarPaymentId        String?
  lineItems             Json
  taxAmount             Float           @default(0)
  discountAmount        Float           @default(0)
  totalAmount           Float
  invoiceUrl            String?
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt
  subscription          Subscription    @relation(fields: [subscriptionId], references: [id])

  @@index([subscriptionId])
  @@index([brandId])
  @@index([status])
  @@index([createdAt])
  @@map("subscription_invoices")
}

model AuditLog {
  id        String   @id @default(uuid())
  userId    String?
  action    String
  entity    String
  entityId  String?
  metadata  Json?
  createdAt DateTime @default(now())
  user      User?    @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([entity, entityId])
  @@map("audit_logs")
}

model AIUsageLog {
  id        String   @id @default(uuid())
  brandId   String
  feature   String
  timestamp DateTime @default(now())
  metadata  Json?
  brand     Brand    @relation(fields: [brandId], references: [id], onDelete: Cascade)

  @@index([brandId])
  @@index([timestamp])
  @@index([feature])
  @@map("ai_usage_logs")
}

model Country {
  id       String   @id @default(uuid())
  code     String   @unique
  name     String
  currency String
  branches Branch[]
  brands   Brand[]

  @@map("countries")
}

model MenuCategory {
  id        String         @id @default(uuid())
  brandId   String
  name      String
  parentId  String?
  sortOrder Int            @default(0)
  isActive  Boolean        @default(true)
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt
  items     ItemCategory[]
  brand     Brand          @relation(fields: [brandId], references: [id])
  parent    MenuCategory?  @relation("CategoryChildren", fields: [parentId], references: [id])
  children  MenuCategory[] @relation("CategoryChildren")

  @@index([brandId])
  @@map("menu_categories")
}

model MenuItem {
  id             String              @id @default(uuid())
  brandId        String
  defaultName    String
  description    String?
  sku            String?             @unique
  imageUrl       String?
  isActive       Boolean             @default(true)
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt
  branchVariants BranchItemVariant[]
  categories     ItemCategory[]
  modifierLinks  ItemModifierGroup[]
  itemRoutes     ItemRoute[]
  i18n           MenuItemI18n[]
  variants       ItemVariant[]
  brand          Brand               @relation(fields: [brandId], references: [id])
  OrderItem      OrderItem[]
  recipes        Recipe[]

  @@index([brandId])
  @@map("menu_items")
}

model MenuItemI18n {
  itemId      String
  locale      String
  name        String
  description String?
  item        MenuItem @relation(fields: [itemId], references: [id])

  @@id([itemId, locale])
  @@map("menu_item_i18n")
}

model ItemVariant {
  id              String                     @id @default(uuid())
  itemId          String
  name            String
  price           Decimal                    @db.Decimal(12, 2)
  costPrice       Decimal?                   @db.Decimal(12, 2)
  sku             String?
  isActive        Boolean                    @default(true)
  sortOrder       Int                        @default(0)
  createdAt       DateTime                   @default(now())
  updatedAt       DateTime                   @updatedAt
  branchOverrides BranchItemVariant[]
  modifierLinks   ItemVariantModifierGroup[]
  item            MenuItem                   @relation(fields: [itemId], references: [id])
  OrderItem       OrderItem[]
  recipes         Recipe[]
  variantRoutes   VariantRoute[]

  @@index([itemId])
  @@map("menu_item_variants")
}

model ModifierGroup {
  id           String                     @id @default(uuid())
  brandId      String
  name         String
  minSelect    Int                        @default(0)
  maxSelect    Int                        @default(1)
  required     Boolean                    @default(false)
  isActive     Boolean                    @default(true)
  createdAt    DateTime                   @default(now())
  updatedAt    DateTime                   @updatedAt
  itemLinks    ItemModifierGroup[]
  variantLinks ItemVariantModifierGroup[]
  brand        Brand                      @relation(fields: [brandId], references: [id])
  options      ModifierOption[]

  @@index([brandId])
  @@map("modifier_groups")
}

model ModifierOption {
  id                 String              @id @default(uuid())
  groupId            String
  name               String
  price              Decimal             @db.Decimal(12, 2)
  isActive           Boolean             @default(true)
  sortOrder          Int                 @default(0)
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  group              ModifierGroup       @relation(fields: [groupId], references: [id])
  orderItemModifiers OrderItemModifier[]

  @@index([groupId])
  @@map("modifier_options")
}

/// Pivot: Item ↔ Category (many-to-many)
model ItemCategory {
  itemId     String
  categoryId String
  category   MenuCategory @relation(fields: [categoryId], references: [id])
  item       MenuItem     @relation(fields: [itemId], references: [id])

  @@id([itemId, categoryId])
  @@map("item_categories")
}

/// Pivot: Item ↔ ModifierGroup
model ItemModifierGroup {
  itemId   String
  groupId  String
  required Boolean       @default(false)
  group    ModifierGroup @relation(fields: [groupId], references: [id])
  item     MenuItem      @relation(fields: [itemId], references: [id])

  @@id([itemId, groupId])
  @@map("item_modifier_groups")
}

/// Pivot: Variant ↔ ModifierGroup (lets groups differ by variant)
model ItemVariantModifierGroup {
  variantId String
  groupId   String
  group     ModifierGroup @relation(fields: [groupId], references: [id])
  variant   ItemVariant   @relation(fields: [variantId], references: [id])

  @@id([variantId, groupId])
  @@map("item_variant_modifier_groups")
}

/// Per-branch variant price & availability override
model BranchItemVariant {
  branchId    String
  variantId   String
  price       Decimal?    @db.Decimal(12, 2)
  isAvailable Boolean     @default(true)
  menuItemId  String?
  branch      Branch      @relation(fields: [branchId], references: [id])
  MenuItem    MenuItem?   @relation(fields: [menuItemId], references: [id])
  variant     ItemVariant @relation(fields: [variantId], references: [id])

  @@id([branchId, variantId])
  @@map("branch_item_variants")
}

model Supplier {
  id             String          @id @default(uuid())
  brandId        String
  name           String
  contactName    String?
  phone          String?
  email          String?
  address        String?
  notes          String?
  isActive       Boolean         @default(true)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  purchaseOrders PurchaseOrder[]
  brand          Brand           @relation(fields: [brandId], references: [id])

  @@index([brandId])
  @@index([name])
  @@map("suppliers")
}

model Product {
  id                String              @id @default(uuid())
  brandId           String
  name              String
  sku               String?             @unique
  unit              String
  costPrice         Decimal             @db.Decimal(10, 2)
  isActive          Boolean             @default(true)
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  barcode           String?             @unique
  categoryId        String?
  description       String?
  sellPrice         Decimal             @db.Decimal(10, 2)
  trackStock        Boolean             @default(true)
  brand             Brand               @relation(fields: [brandId], references: [id])
  category          Category?           @relation(fields: [categoryId], references: [id])
  PurchaseOrderItem PurchaseOrderItem[]
  RecipeItem        RecipeItem[]
  StockAdjustment   StockAdjustment[]
  stockItems        StockItem[]
  StockTransaction  StockTransaction[]
  StockTransferItem StockTransferItem[]

  @@index([brandId])
  @@index([name])
  @@map("products")
}

model Category {
  id        String    @id @default(uuid())
  brandId   String
  name      String
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  brand     Brand     @relation(fields: [brandId], references: [id])
  products  Product[]

  @@index([brandId])
  @@index([name])
  @@map("categories")
}

model StockItem {
  id        String   @id @default(uuid())
  productId String
  quantity  Decimal  @db.Decimal(12, 3)
  location  String?
  updatedAt DateTime @updatedAt
  createdAt DateTime @default(now())
  product   Product  @relation(fields: [productId], references: [id])

  @@index([productId])
  @@map("stock_items")
}

model StockTransaction {
  id        String      @id @default(uuid())
  brandId   String
  productId String
  quantity  Decimal     @db.Decimal(12, 3)
  unitCost  Decimal?    @db.Decimal(10, 2)
  createdAt DateTime    @default(now())
  notes     String?
  reference String?
  userId    String?
  type      StockTxType
  brand     Brand       @relation(fields: [brandId], references: [id])
  product   Product     @relation(fields: [productId], references: [id])
  user      User?       @relation(fields: [userId], references: [id])

  @@index([brandId])
  @@index([productId])
  @@index([type])
  @@map("stock_transactions")
}

model PurchaseOrder {
  id          String              @id @default(uuid())
  brandId     String
  supplierId  String
  totalAmount Decimal             @db.Decimal(12, 2)
  createdAt   DateTime            @default(now())
  createdBy   String?
  updatedAt   DateTime            @updatedAt
  status      POStatus            @default(DRAFT)
  items       PurchaseOrderItem[]
  brand       Brand               @relation(fields: [brandId], references: [id])
  user        User?               @relation(fields: [createdBy], references: [id])
  supplier    Supplier            @relation(fields: [supplierId], references: [id])

  @@index([brandId])
  @@index([supplierId])
  @@map("purchase_orders")
}

model PurchaseOrderItem {
  id              String        @id @default(uuid())
  productId       String
  quantity        Decimal       @db.Decimal(12, 3)
  unitCost        Decimal       @db.Decimal(10, 2)
  purchaseOrderId String
  receivedQty     Decimal       @default(0) @db.Decimal(12, 3)
  product         Product       @relation(fields: [productId], references: [id])
  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id])

  @@index([purchaseOrderId])
  @@index([productId])
  @@map("purchase_order_items")
}

model StockAdjustment {
  id        String   @id @default(uuid())
  brandId   String
  productId String
  quantity  Decimal  @db.Decimal(12, 3)
  reason    String
  userId    String?
  createdAt DateTime @default(now())
  brand     Brand    @relation(fields: [brandId], references: [id])
  product   Product  @relation(fields: [productId], references: [id])
  user      User?    @relation(fields: [userId], references: [id])

  @@index([brandId])
  @@index([productId])
  @@map("stock_adjustments")
}

model StockTransfer {
  id           String              @id @default(uuid())
  brandId      String
  fromBranchId String
  toBranchId   String
  createdAt    DateTime            @default(now())
  createdById  String
  status       StockTransferStatus @default(PENDING)
  items        StockTransferItem[]
  brand        Brand               @relation(fields: [brandId], references: [id])
  createdBy    User                @relation(fields: [createdById], references: [id])
  fromBranch   Branch              @relation("TransferFromBranch", fields: [fromBranchId], references: [id])
  toBranch     Branch              @relation("TransferToBranch", fields: [toBranchId], references: [id])

  @@index([brandId])
  @@index([fromBranchId])
  @@index([toBranchId])
  @@index([status])
  @@map("stock_transfers")
}

model StockTransferItem {
  id         String        @id @default(uuid())
  transferId String
  productId  String
  quantity   Decimal       @db.Decimal(12, 3)
  product    Product       @relation(fields: [productId], references: [id])
  transfer   StockTransfer @relation(fields: [transferId], references: [id])

  @@index([transferId])
  @@index([productId])
  @@map("stock_transfer_items")
}

model Recipe {
  id        String       @id @default(uuid())
  brandId   String
  itemId    String?
  variantId String?
  name      String
  isActive  Boolean      @default(true)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
  lines     RecipeItem[]
  brand     Brand        @relation(fields: [brandId], references: [id])
  item      MenuItem?    @relation(fields: [itemId], references: [id])
  variant   ItemVariant? @relation(fields: [variantId], references: [id])

  @@index([brandId])
  @@index([itemId])
  @@index([variantId])
  @@map("recipes")
}

model RecipeItem {
  id        String   @id @default(uuid())
  recipeId  String
  productId String
  quantity  Decimal  @db.Decimal(12, 3)
  wastePct  Decimal? @db.Decimal(5, 2)
  product   Product  @relation(fields: [productId], references: [id])
  recipe    Recipe   @relation(fields: [recipeId], references: [id])

  @@index([recipeId])
  @@index([productId])
  @@map("recipe_items")
}

model Zone {
  id        String   @id @default(uuid())
  name      String
  branchId  String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  brandId   String?
  tables    Table[]
  branch    Branch   @relation(fields: [branchId], references: [id], onDelete: Cascade)
  Brand     Brand?   @relation(fields: [brandId], references: [id])

  @@index([branchId, name], map: "idx_zone_branch_name")
  @@map("zones")
}

model Table {
  id           String        @id @default(uuid())
  name         String
  capacity     Int
  branchId     String
  zoneId       String?
  status       TableStatus   @default(AVAILABLE)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  brandId      String?
  code         String?       @unique
  orders       Order[]
  reservations Reservation[]
  branch       Branch        @relation(fields: [branchId], references: [id], onDelete: Cascade)
  Brand        Brand?        @relation(fields: [brandId], references: [id])
  zone         Zone?         @relation(fields: [zoneId], references: [id])

  @@index([branchId, name], map: "idx_table_branch_name")
  @@index([zoneId], map: "idx_table_zone")
  @@map("tables")
}

model Register {
  id          String            @id @default(uuid())
  brandId     String?
  branchId    String
  name        String
  isActive    Boolean           @default(true)
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  CashSession CashSession[]
  sessions    RegisterSession[]
  branch      Branch            @relation(fields: [branchId], references: [id], onDelete: Cascade)
  Brand       Brand?            @relation(fields: [brandId], references: [id])

  @@index([branchId, name], map: "idx_register_branch_name")
  @@map("registers")
}

model RegisterSession {
  id             String         @id @default(uuid())
  registerId     String
  brandId        String
  branchId       String
  openedById     String
  closedById     String?
  status         RegisterStatus @default(OPEN)
  openingBalance Decimal        @db.Decimal(12, 2)
  closingBalance Decimal?       @db.Decimal(12, 2)
  notes          String?
  openedAt       DateTime       @default(now())
  closedAt       DateTime?
  payments       Payment[]
  branch         Branch         @relation(fields: [branchId], references: [id])
  brand          Brand          @relation(fields: [brandId], references: [id])
  closedBy       User?          @relation("RegisterClosedBy", fields: [closedById], references: [id])
  openedBy       User           @relation("RegisterOpenedBy", fields: [openedById], references: [id])
  register       Register       @relation(fields: [registerId], references: [id])

  @@index([brandId])
  @@index([branchId])
  @@index([registerId])
  @@map("register_sessions")
}

model CashSession {
  id            String         @id @default(uuid())
  registerId    String
  openedById    String
  closedById    String?
  openingFloat  Decimal        @db.Decimal(12, 2)
  cashSales     Decimal        @default(0) @db.Decimal(12, 2)
  refunds       Decimal        @default(0) @db.Decimal(12, 2)
  paidIn        Decimal        @default(0) @db.Decimal(12, 2)
  paidOut       Decimal        @default(0) @db.Decimal(12, 2)
  adjustments   Decimal        @default(0) @db.Decimal(12, 2)
  expectedClose Decimal        @default(0) @db.Decimal(12, 2)
  countedClose  Decimal?       @db.Decimal(12, 2)
  overShort     Decimal?       @db.Decimal(12, 2)
  status        SessionStatus  @default(OPEN)
  openedAt      DateTime       @default(now())
  closedAt      DateTime?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  brandId       String?
  branchId      String?
  movements     CashMovement[]
  Branch        Branch?        @relation(fields: [branchId], references: [id])
  Brand         Brand?         @relation(fields: [brandId], references: [id])
  closedBy      User?          @relation("SessionClosedBy", fields: [closedById], references: [id])
  openedBy      User           @relation("SessionOpenedBy", fields: [openedById], references: [id])
  register      Register       @relation(fields: [registerId], references: [id], onDelete: Cascade)

  @@index([registerId, status], map: "idx_session_register_status")
  @@index([openedAt], map: "idx_session_opened_at")
  @@map("cash_sessions")
}

model CashMovement {
  id        String       @id @default(uuid())
  sessionId String
  type      MovementType
  amount    Decimal      @db.Decimal(12, 2)
  reason    String?
  orderId   String?
  userId    String?
  createdAt DateTime     @default(now())
  brandId   String?
  branchId  String?
  Branch    Branch?      @relation(fields: [branchId], references: [id])
  Brand     Brand?       @relation(fields: [brandId], references: [id])
  session   CashSession  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user      User?        @relation(fields: [userId], references: [id])

  @@index([sessionId, type], map: "idx_movement_session_type")
  @@index([orderId], map: "idx_movement_order")
  @@map("cash_movements")
}

model TaxRate {
  id          String     @id @default(uuid())
  brandId     String
  branchId    String?
  scope       TaxScope
  name        String
  ratePct     Decimal    @db.Decimal(5, 2)
  isInclusive Boolean    @default(false)
  isActive    Boolean    @default(true)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  OrderTax    OrderTax[]
  branch      Branch?    @relation(fields: [branchId], references: [id])
  brand       Brand      @relation(fields: [brandId], references: [id])

  @@index([brandId])
  @@index([branchId])
  @@map("tax_rates")
}

model ServiceChargeConfig {
  id        String       @id @default(uuid())
  brandId   String
  branchId  String?
  name      String       @default("Service Charge")
  type      DiscountType @default(PERCENT)
  value     Decimal      @db.Decimal(7, 2)
  minCovers Int?
  isActive  Boolean      @default(true)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
  branch    Branch?      @relation(fields: [branchId], references: [id])
  brand     Brand        @relation(fields: [brandId], references: [id])

  @@index([brandId])
  @@index([branchId])
  @@map("service_charge_configs")
}

model Customer {
  id          String            @id @default(uuid())
  brandId     String
  firstName   String
  lastName    String?
  phone       String?
  email       String?
  notes       String?
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  addresses   CustomerAddress[]
  brand       Brand             @relation(fields: [brandId], references: [id])
  orders      Order[]
  Reservation Reservation[]

  @@index([brandId])
  @@index([phone])
  @@index([email])
  @@map("customers")
}

model CustomerAddress {
  id         String   @id @default(uuid())
  customerId String
  label      String?
  line1      String
  line2      String?
  city       String?
  state      String?
  postalCode String?
  country    String?
  customer   Customer @relation(fields: [customerId], references: [id])

  @@index([customerId])
  @@map("customer_addresses")
}

model Order {
  id              String            @id @default(uuid())
  brandId         String
  branchId        String
  tableId         String?
  customerId      String?
  total           Decimal           @default(0) @db.Decimal(12, 2)
  createdAt       DateTime          @default(now())
  createdById     String
  closedAt        DateTime?
  covers          Int?
  discount        Decimal           @default(0) @db.Decimal(12, 2)
  notes           String?
  paidTotal       Decimal           @default(0) @db.Decimal(12, 2)
  service         Decimal           @default(0) @db.Decimal(12, 2)
  subtotal        Decimal           @default(0) @db.Decimal(12, 2)
  tax             Decimal           @default(0) @db.Decimal(12, 2)
  tip             Decimal           @default(0) @db.Decimal(12, 2)
  type            OrderType         @default(DINE_IN)
  status          OrderStatus       @default(DRAFT)
  waiterId        String?
  billType        BillType          @default(FINE_DINE)
  KitchenTicket   KitchenTicket[]
  items           OrderItem[]
  logs            OrderLog[]
  taxes           OrderTax[]
  branch          Branch            @relation(fields: [branchId], references: [id])
  brand           Brand             @relation(fields: [brandId], references: [id])
  createdBy       User              @relation("OrderCreatedBy", fields: [createdById], references: [id])
  customer        Customer?         @relation(fields: [customerId], references: [id])
  table           Table?            @relation(fields: [tableId], references: [id])
  waiter          User?             @relation("OrderWaiter", fields: [waiterId], references: [id])
  payments        Payment[]
  PromoRedemption PromoRedemption[]
  Tip             Tip[]

  @@index([brandId])
  @@index([branchId])
  @@index([status])
  @@index([type])
  @@map("orders")
}

model OrderItem {
  id        String              @id @default(uuid())
  orderId   String
  variantId String?
  quantity  Int
  basePrice Decimal             @db.Decimal(12, 2)
  isVoided  Boolean             @default(false)
  itemId    String
  linePrice Decimal             @db.Decimal(12, 2)
  notes     String?
  routeToId String?
  tickets   KitchenTicketItem[]
  modifiers OrderItemModifier[]
  item      MenuItem            @relation(fields: [itemId], references: [id])
  order     Order               @relation(fields: [orderId], references: [id])
  routeTo   KitchenStation?     @relation(fields: [routeToId], references: [id])
  variant   ItemVariant?        @relation(fields: [variantId], references: [id])

  @@index([orderId])
  @@index([itemId])
  @@index([variantId])
  @@map("order_items")
}

model OrderItemModifier {
  id          String         @id @default(uuid())
  orderItemId String
  optionId    String
  price       Decimal        @db.Decimal(12, 2)
  option      ModifierOption @relation(fields: [optionId], references: [id])
  orderItem   OrderItem      @relation(fields: [orderItemId], references: [id])

  @@index([orderItemId])
  @@index([optionId])
  @@map("order_item_modifiers")
}

model OrderLog {
  id        String      @id @default(uuid())
  orderId   String
  status    OrderStatus
  message   String?
  userId    String?
  createdAt DateTime    @default(now())
  order     Order       @relation(fields: [orderId], references: [id])
  user      User?       @relation(fields: [userId], references: [id])

  @@index([orderId])
  @@index([status])
  @@map("order_logs")
}

model Payment {
  id        String           @id @default(uuid())
  brandId   String
  branchId  String
  orderId   String
  sessionId String?
  method    PaymentMethod
  amount    Decimal          @db.Decimal(12, 2)
  tipAmount Decimal          @default(0) @db.Decimal(12, 2)
  reference String?
  metadata  Json?
  createdAt DateTime         @default(now())
  refunds   PaymentRefund[]
  branch    Branch           @relation(fields: [branchId], references: [id])
  brand     Brand            @relation(fields: [brandId], references: [id])
  order     Order            @relation(fields: [orderId], references: [id])
  session   RegisterSession? @relation(fields: [sessionId], references: [id])

  @@index([brandId])
  @@index([branchId])
  @@index([orderId])
  @@map("payments")
}

model PaymentRefund {
  id        String   @id @default(uuid())
  paymentId String
  amount    Decimal  @db.Decimal(12, 2)
  reason    String?
  createdAt DateTime @default(now())
  payment   Payment  @relation(fields: [paymentId], references: [id])

  @@index([paymentId])
  @@map("payment_refunds")
}

model OrderTax {
  id        String  @id @default(uuid())
  orderId   String
  taxRateId String
  name      String
  ratePct   Decimal @db.Decimal(5, 2)
  amount    Decimal @db.Decimal(12, 2)
  order     Order   @relation(fields: [orderId], references: [id])
  taxRate   TaxRate @relation(fields: [taxRateId], references: [id])

  @@index([orderId])
  @@index([taxRateId])
  @@map("order_taxes")
}

model KitchenStation {
  id            String          @id @default(uuid())
  brandId       String
  branchId      String
  name          String
  isActive      Boolean         @default(true)
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  itemRoutes    ItemRoute[]
  branch        Branch          @relation(fields: [branchId], references: [id])
  brand         Brand           @relation(fields: [brandId], references: [id])
  tickets       KitchenTicket[]
  OrderItem     OrderItem[]
  variantRoutes VariantRoute[]

  @@unique([branchId, name])
  @@index([brandId])
  @@index([branchId])
  @@map("kitchen_stations")
}

model ItemRoute {
  stationId String
  itemId    String
  item      MenuItem       @relation(fields: [itemId], references: [id])
  station   KitchenStation @relation(fields: [stationId], references: [id])

  @@id([stationId, itemId])
  @@map("item_routes")
}

model VariantRoute {
  stationId String
  variantId String
  station   KitchenStation @relation(fields: [stationId], references: [id])
  variant   ItemVariant    @relation(fields: [variantId], references: [id])

  @@id([stationId, variantId])
  @@map("variant_routes")
}

model KitchenTicket {
  id        String              @id @default(uuid())
  brandId   String
  branchId  String
  orderId   String
  stationId String
  status    KitchenTicketStatus @default(NEW)
  createdAt DateTime            @default(now())
  updatedAt DateTime            @updatedAt
  items     KitchenTicketItem[]
  branch    Branch              @relation(fields: [branchId], references: [id])
  brand     Brand               @relation(fields: [brandId], references: [id])
  order     Order               @relation(fields: [orderId], references: [id])
  station   KitchenStation      @relation(fields: [stationId], references: [id])

  @@index([brandId])
  @@index([branchId])
  @@index([orderId])
  @@index([stationId])
  @@map("kitchen_tickets")
}

model KitchenTicketItem {
  id          String              @id @default(uuid())
  ticketId    String
  orderItemId String
  status      KitchenTicketStatus @default(NEW)
  orderItem   OrderItem           @relation(fields: [orderItemId], references: [id])
  ticket      KitchenTicket       @relation(fields: [ticketId], references: [id])

  @@index([ticketId])
  @@index([orderItemId])
  @@map("kitchen_ticket_items")
}

model Printer {
  id        String      @id @default(uuid())
  brandId   String
  branchId  String
  name      String
  type      PrinterType @default(RECEIPT)
  deviceUri String
  isActive  Boolean     @default(true)
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  jobs      PrintJob[]
  branch    Branch      @relation(fields: [branchId], references: [id])
  brand     Brand       @relation(fields: [brandId], references: [id])

  @@unique([branchId, name])
  @@index([brandId])
  @@index([branchId])
  @@map("printers")
}

model PrintJob {
  id        String    @id @default(uuid())
  brandId   String
  branchId  String
  printerId String
  payload   Json
  status    String    @default("QUEUED")
  createdAt DateTime  @default(now())
  sentAt    DateTime?
  branch    Branch    @relation(fields: [branchId], references: [id])
  brand     Brand     @relation(fields: [brandId], references: [id])
  printer   Printer   @relation(fields: [printerId], references: [id])

  @@index([brandId])
  @@index([branchId])
  @@index([printerId])
  @@map("print_jobs")
}

model Reservation {
  id         String            @id @default(uuid())
  brandId    String
  branchId   String
  tableId    String?
  customerId String?
  status     ReservationStatus @default(PENDING)
  covers     Int
  reservedAt DateTime
  notes      String?
  createdAt  DateTime          @default(now())
  updatedAt  DateTime          @updatedAt
  branch     Branch            @relation(fields: [branchId], references: [id])
  brand      Brand             @relation(fields: [brandId], references: [id])
  customer   Customer?         @relation(fields: [customerId], references: [id])
  table      Table?            @relation(fields: [tableId], references: [id])

  @@index([brandId])
  @@index([branchId])
  @@index([reservedAt])
  @@map("reservations")
}

model WaitlistEntry {
  id        String   @id @default(uuid())
  brandId   String
  branchId  String
  name      String
  phone     String?
  covers    Int
  notes     String?
  status    String   @default("WAITING")
  createdAt DateTime @default(now())
  branch    Branch   @relation(fields: [branchId], references: [id])
  brand     Brand    @relation(fields: [brandId], references: [id])

  @@index([brandId])
  @@index([branchId])
  @@map("waitlist")
}

model Tip {
  id         String    @id @default(cuid())
  brandId    String
  branchId   String
  orderId    String?
  registerId String?
  staffId    String?
  amount     Decimal   @db.Decimal(12, 2)
  note       String?
  createdAt  DateTime  @default(now())
  method     TipMethod @default(CASH)
  type       TipType   @default(DIRECT)
  branch     Branch    @relation(fields: [branchId], references: [id])
  brand      Brand     @relation(fields: [brandId], references: [id])
  order      Order?    @relation(fields: [orderId], references: [id])
  staff      User?     @relation(fields: [staffId], references: [id])

  @@index([brandId])
  @@index([branchId])
  @@index([orderId])
  @@index([registerId])
  @@index([staffId])
  @@map("tips")
}

model TipSettlement {
  id          String          @id @default(cuid())
  brandId     String
  branchId    String
  registerId  String?
  date        DateTime        @default(now())
  total       Decimal
  rule        String
  createdAt   DateTime        @default(now())
  allocations TipAllocation[]
  branch      Branch          @relation(fields: [branchId], references: [id])
  brand       Brand           @relation(fields: [brandId], references: [id])

  @@index([brandId])
  @@index([branchId])
  @@index([registerId])
  @@map("tip_settlements")
}

model TipAllocation {
  id           String        @id @default(cuid())
  settlementId String
  staffId      String
  amount       Decimal
  createdAt    DateTime      @default(now())
  settlement   TipSettlement @relation(fields: [settlementId], references: [id])
  staff        User          @relation(fields: [staffId], references: [id])

  @@index([settlementId])
  @@index([staffId])
  @@map("tip_allocations")
}

model Promotion {
  id             String            @id @default(uuid())
  brandId        String
  code           String            @unique
  name           String
  type           DiscountType
  value          Decimal           @db.Decimal(7, 2)
  startsAt       DateTime?
  endsAt         DateTime?
  minSubtotal    Decimal?          @db.Decimal(12, 2)
  maxRedemptions Int?
  timesRedeemed  Int               @default(0)
  isActive       Boolean           @default(true)
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  redemptions    PromoRedemption[]
  brand          Brand             @relation(fields: [brandId], references: [id])

  @@index([brandId, isActive])
  @@map("promotions")
}

model PromoRedemption {
  id          String    @id @default(uuid())
  promotionId String
  orderId     String
  amount      Decimal   @db.Decimal(12, 2)
  createdAt   DateTime  @default(now())
  order       Order     @relation(fields: [orderId], references: [id])
  promotion   Promotion @relation(fields: [promotionId], references: [id])

  @@unique([promotionId, orderId])
  @@index([orderId])
  @@map("promo_redemptions")
}

model DemoRequest {
  id         String            @id @default(uuid())
  email      String            @unique
  firstName  String?
  lastName   String?
  company    String?
  message    String?
  status     DemoRequestStatus @default(PENDING)
  createdAt  DateTime          @default(now())
  updatedAt  DateTime          @updatedAt
  approvedAt DateTime?
  phone      String?
  code       RegistrationCode?

  @@map("demo_requests")
}

model RegistrationCode {
  id            String       @id @default(uuid())
  code          String       @unique
  email         String
  isUsed        Boolean      @default(false)
  expiresAt     DateTime
  createdAt     DateTime     @default(now())
  demoRequestId String?      @unique
  demoRequest   DemoRequest? @relation(fields: [demoRequestId], references: [id])

  @@map("registration_codes")
}

enum Role {
  SUPER_ADMIN
  BRAND_OWNER
  BRAND_ADMIN
  BRANCH_MANAGER
  STAFF
}

enum InvoiceStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
  VOID
}

enum SubscriptionStatus {
  ACTIVE
  TRIALING
  PAST_DUE
  CANCELED
  EXPIRED
}

enum PaymentProvider {
  STRIPE
  POLAR
}

enum BillType {
  FINE_DINE
  QUICK_BILL
}

enum StockTxType {
  PURCHASE
  ADJUSTMENT
  WASTAGE
  TRANSFER
  SALE
  RETURN
}

enum POStatus {
  DRAFT
  SENT
  RECEIVED
  PARTIAL
  CANCELLED
}

enum TableStatus {
  AVAILABLE
  OCCUPIED
  RESERVED
  OUT_OF_SERVICE
}

enum RegisterStatus {
  OPEN
  CLOSED
}

enum SessionStatus {
  OPEN
  CLOSED
  CANCELLED
}

enum MovementType {
  SALE
  REFUND
  PAID_IN
  PAID_OUT
  ADJUSTMENT
}

enum TaxScope {
  BRAND
  BRANCH
}

enum DiscountType {
  PERCENT
  AMOUNT
}

enum OrderType {
  DINE_IN
  TAKEAWAY
  DELIVERY
  ONLINE
}

enum OrderStatus {
  DRAFT
  OPEN
  IN_PROGRESS
  READY
  SERVED
  PART_PAID
  PAID
  CANCELLED
  REFUNDED
}

enum KitchenTicketStatus {
  NEW
  ACCEPTED
  PREPARING
  READY
  SERVED
  VOIDED
}

enum PaymentMethod {
  CASH
  CARD
  UPI
  STRIPE
  PAYSTACK
  FLUTTERWAVE
  OTHER
}

enum ReservationStatus {
  PENDING
  CONFIRMED
  SEATED
  CANCELLED
  NO_SHOW
}

enum PrinterType {
  RECEIPT
  KITCHEN
}

enum StockTransferStatus {
  PENDING
  IN_TRANSIT
  COMPLETED
  CANCELLED
}

enum TipMethod {
  CASH
  CARD
  OTHER
}

enum TipType {
  DIRECT
  POOLED
  BRANCH
}

enum TipSettlementRule {
  EQUAL
  HOURS
  SALES
}

enum WaitlistStatus {
  WAITING
  NOTIFIED
  SEATED
  LEFT
}

enum PrintJobStatus {
  QUEUED
  SENT
  FAILED
}

enum DemoRequestStatus {
  PENDING
  APPROVED
  REJECTED
}
